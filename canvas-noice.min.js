!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t="undefined"!=typeof globalThis?globalThis:t||self).CanvasNoice=i()}(this,(function(){"use strict";const t=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||window.oRequestAnimationFrame||function(t){return window.setTimeout(t,1e3/60)},i=window.cancelAnimationFrame||window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||window.msCancelAnimationFrame||window.oCancelAnimationFrame||window.clearTimeout;class e{constructor(t,i){this.x=t*Math.random(),this.y=i*Math.random(),this.vx=2*(2*Math.random()-1),this.vy=2*(2*Math.random()-1),this.lazy={touched:0,near:0,sleep_frame:0},this.pointer_inter=!1}evolve(){CNCONFIG.pointer_interaction||!this.pointer_inter?(this.x+=this.vx,this.y+=this.vy,CNCONFIG.RANDOMNESS_ACTIVE&&!this.pointer_inter&&(this.vx+=(2*Math.random()-1)/10,this.vy+=(2*Math.random()-1)/10),Math.abs(this.vx)>CNCONFIG.particle_max_speed&&(this.vx*=CNCONFIG.particle_slow_down_rate),Math.abs(this.vy)>CNCONFIG.particle_max_speed&&(this.vy*=CNCONFIG.particle_slow_down_rate),this.lazy.sleep_frame>0||(this.lazy.sleep_frame=Math.round(60*CNCONFIG.tabu_index*Math.max(this.lazy.near/this.lazy.touched-CNCONFIG.lazy_overload_threshold,0)),this.lazy.touched=0,this.lazy.near=0)):this.pointer_inter=!1}calAlpha(t){return Number(Math.min(1.2-t/CNCONFIG.max_d,1).toFixed(1))}calInterWithPointer(t){const i=t.x-this.x,e=t.y-this.y,n=Math.hypot(i,e);if(!(n>CNCONFIG.max_d||n<1)){if(this.pointer_inter=!0,CNCONFIG.pointer_interaction){let t;n>CNCONFIG.max_d/1.3?t=2:n<CNCONFIG.max_d&&(t=-2);const s=Math.pow(n-CNCONFIG.max_d/4,-1)*CNCONFIG.pointer_gravity_constant*t/10,o={x:Math.sign(i)*s,y:Math.sign(e)*s};this.vx+=o.x,this.vy+=o.y}else this.vx=0,this.vy=0;return{a:this.calAlpha(n),pos_info:[this.x,this.y,t.x,t.y]}}}calInterWithPoint(t,i){if(this.lazy.sleep_frame)this.lazy.sleep_frame--;else{const e=t.x-this.x,n=t.y-this.y,s=Math.hypot(e,n);if(s>CNCONFIG.max_d||s<1)return;if(this.lazy.touched++,s<=CNCONFIG.max_d/3&&this.lazy.near++,!CNCONFIG.pointer_interaction&&CNCONFIG.GRAVITY_ACTIVE){const t=Math.pow(s,-2)*CNCONFIG.gravity_constant,i={x:Math.sign(e)*t,y:Math.sign(n)*t};this.vx+=i.x,this.vy+=i.y}if(i)return{a:this.calAlpha(s),pos_info:[this.x,this.y,t.x,t.y]}}}}class n{constructor(t,i,e,n,s){this.x=t,this.y=i,this.w=e,this.h=n,this.points=[],this.traversed=!1}}class s{constructor(t,i){this.ready=!1,this.w=t,this.h=i,this.chunk_w=this.w/CNCONFIG.X_CHUNK,this.chunk_h=this.h/CNCONFIG.Y_CHUNK,this.chunks=[],this.genChunks(),this.wait_refill_num=0}genChunks(){this.chunks=new Array(CNCONFIG.X_CHUNK).fill(null).map((()=>new Array(CNCONFIG.Y_CHUNK).fill(null)));for(let t=0;t<CNCONFIG.X_CHUNK;t++)for(let i=0;i<CNCONFIG.Y_CHUNK;i++)this.chunks[t][i]=new n(this.chunk_w*t,this.chunk_h*i,this.chunk_w,this.chunk_h);this.ready=!0}insertPoint(t){if(!this.ready)return;const i=Math.floor(t.x/this.chunk_w),e=Math.floor(t.y/this.chunk_h),n=this.chunks[i][e];n.points.length<CNCONFIG.chunk_current_capacity?n.points.push(t):this.wait_refill_num++}randomRemovePoints(t){if(!this.ready)return;const i=Math.max(Math.floor(t/10),1);for(;t>0;){const e=Math.floor(Math.random()*CNCONFIG.X_CHUNK);for(let n=0;n<CNCONFIG.Y_CHUNK;n++){const s=this.chunks[e][n];let o;if(s.points.length>i){for(let t=0;t<i;t++)s.points.pop();o=i}else o=s.points.length,s.points=[];t-=o}}}decCapacity(t){CNCONFIG.chunk_current_capacity=Math.max(CNCONFIG.chunk_min_capacity,CNCONFIG.chunk_current_capacity-t)}incCapacity(t){CNCONFIG.chunk_current_capacity=Math.min(CNCONFIG.chunk_max_capacity,CNCONFIG.chunk_current_capacity+t)}}class o{constructor(t,i,n){this.ctx=t,this.ctx.fillStyle=`rgb(${CNCONFIG.point_color})`,this.grid=i,this.pointer=n;for(let t=0;t<CNCONFIG.point_count;t++)this.grid.insertPoint(new e(this.grid.w,this.grid.h));this.draw_buffer=new Array(9).fill(null).map((()=>[]))}async traverse(){for(let t=0;;t++){let i=[];if(t>=0&&t<CNCONFIG.X_CHUNK&&i.push(this.calVerticalInteraction(t)),t-2>=0&&t-2<CNCONFIG.X_CHUNK&&i.push(this.evolveVerticalChunks(t-2)),t-4>=0&&t-4<CNCONFIG.X_CHUNK&&i.push(this.updateVerticalChunks(t-4)),0===i.length){this.drawLinesInBuffer();break}await Promise.all(i)}}loadInfoIntoDrawBuffer(t){t&&this.draw_buffer[10*t.a-2].push(t.pos_info)}drawLinesInBufferSlot(t){const i=this.draw_buffer[t];this.ctx.beginPath();const e=(t+2)/10;this.ctx.lineWidth=e,this.ctx.strokeStyle=`rgba(${CNCONFIG.line_color},${e})`;for(let t=0,e=i.length;t<e;t++){const e=i[t];this.ctx.moveTo(e[0],e[1]),this.ctx.lineTo(e[2],e[3])}this.ctx.stroke(),this.draw_buffer[t]=[]}drawLinesInBuffer(){this.buffer_cur_size=0;for(let t=0;t<9;t++)this.drawLinesInBufferSlot(t)}computeInteractionRange(t,i){const e=i.x-t.x;let n=Math.ceil((CNCONFIG.max_d-e)/i.w-1);const s=i.y-t.y;let o=Math.ceil((CNCONFIG.max_d+s)/i.h),a=Math.ceil((CNCONFIG.max_d-s)/i.h);return CNCONFIG.lossless_computation||(n=Math.min(n,1),o=Math.max(o,-1),a=Math.min(a,1)),{c_dx:[n],c_dy:[o,a]}}async calVerticalInteraction(t){for(let i=0;i<CNCONFIG.Y_CHUNK;i++){const e=this.grid.chunks[t][i];this.calLocalInteraction(e),e.points.forEach((n=>{null!==this.pointer.x&&this.loadInfoIntoDrawBuffer(n.calInterWithPointer(this.pointer));const s=this.computeInteractionRange(n,e);for(let e=0;e<=s.c_dx[0];e++)for(let o=-s.c_dy[0];o<=s.c_dy[1];o++){if(0===e&&0===o)continue;if(t+e>=CNCONFIG.X_CHUNK||i+o<0||i+o>=CNCONFIG.Y_CHUNK)continue;const s=this.grid.chunks[t+e][i+o];s.traversed||this.calSurroundingInteraction(s,n)}})),e.traversed=!0}}calLocalInteraction(t){for(let i=0;i<t.points.length-1;i++){const e=t.points[i];for(let n=i+1;n<t.points.length;n++){const i=t.points[n];this.loadInfoIntoDrawBuffer(e.calInterWithPoint(i,!0)),i.calInterWithPoint(e,!1)}}}calSurroundingInteraction(t,i){t.points.forEach((t=>{this.loadInfoIntoDrawBuffer(i.calInterWithPoint(t,!0)),t.calInterWithPoint(i,!1)}))}async evolveVerticalChunks(t){for(let i=0;i<CNCONFIG.Y_CHUNK;i++){this.grid.chunks[t][i].points.forEach((t=>{this.ctx.fillRect(t.x-.5,t.y-.5,1,1),t.evolve()}))}}async updateVerticalChunks(t){for(let i=0;i<CNCONFIG.Y_CHUNK;i++){const n=this.grid.chunks[t][i];n.traversed=!1;const s=n.x+n.w,o=n.y+n.h;let a=[];for(let h=0;h<n.points.length;h++){const r=n.points[h];let c=0,l=0;if(r.x<n.x?c=-1:r.x>=s&&(c=1),r.y<n.y?l=-1:r.y>=o&&(l=1),0===c&&0===l)continue;const d=t+c,u=i+l;if(d<0)r.x=.1,r.vx*=-1;else if(d>=CNCONFIG.X_CHUNK)r.x=this.grid.w-.1,r.vx*=-1;else if(u<0)r.y=.1,r.vy*=-1;else if(u>=CNCONFIG.Y_CHUNK)r.y=this.grid.h-.1,r.vy*=-1;else{a.push(h);const t=this.grid.chunks[d][u];t.points.length<CNCONFIG.chunk_current_capacity?t.points.push(r):this.grid.insertPoint(new e(this.grid.w,this.grid.h))}}let h=0;n.points=n.points.filter(((t,i)=>h===a.length||i!==a[h]||(h++,!1)))}}draw(){this.ctx.clearRect(0,0,this.grid.w,this.grid.h),this.traverse()}}class a{constructor(t){this.el=document.getElementById("fps"),this.grid=t,this.startTime=void 0,this.frame=0,this.avr_fps=0,this.avr_counter=3,this.stable_counter=0,this.batch=Math.round(CNCONFIG.X_CHUNK*CNCONFIG.Y_CHUNK/30)}async initialize(){await new Promise((t=>setTimeout(t,300))),this.startTime=Date.now(),this.tick(),await new Promise((t=>setTimeout(t,1e3)))}tick(){this.frame++;const i=Date.now(),e=this.avr_counter?300:1e3;if(i-this.startTime>=e){const t=(this.frame/((i-this.startTime)/1e3)).toFixed(1);this.avr_counter?(this.avr_counter--,this.avr_fps+=Number(t),this.avr_counter||(this.avr_fps=Math.round(this.avr_fps/3),console.log("[c-noice.js] Avr. FPS:",this.avr_fps))):(this.objectOptimization(Number(t)),this.el&&(this.el.innerText=t)),this.startTime=i,this.frame=0}t((()=>{this.tick()}))}objectOptimization(t){const i=t/this.avr_fps;if(i>.9){this.grid.incCapacity(Math.round((t-.9*this.avr_fps)/6));const i=Math.round(this.grid.wait_refill_num/(10-Math.min(this.stable_counter/5,8)));for(let t=0;t<i;t++)setTimeout((()=>{this.grid.insertPoint(new e(this.grid.w,this.grid.h))}),2e3*Math.random());this.grid.wait_refill_num-=i,this.stable_counter++}else this.stable_counter=0,i<=.7?(this.grid.decCapacity(3),this.grid.randomRemovePoints(3*this.batch),this.grid.wait_refill_num=0):i<=.8?(this.grid.decCapacity(2),this.grid.randomRemovePoints(2*this.batch),this.grid.wait_refill_num=Math.floor(this.grid.wait_refill_num/3)):i<=.9&&(this.grid.decCapacity(1),this.grid.randomRemovePoints(this.batch))}}return class{constructor(){this.canvas=void 0,this.initializeCanvas(),this.ctx=this.canvas.getContext("2d"),this.grid=void 0,this.fps_manager=void 0,this.simulator=void 0,this.pointer={x:null,y:null,is_pointer:!0},this.registerListener(),this.render_info={draw:!0,need_initialize:!0,delay_after:.2,last_changed_time:0},this.pendingRender()}updateCanvasSize(){this.canvas.width=window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth,this.canvas.height=window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight}resetRenderInfo(){this.render_info.last_changed_time=Date.now(),this.render_info.draw=!1,this.render_info.need_initialize=!0}registerListener(){window.onresize=()=>{i(this.tid),this.updateCanvasSize(),this.resetRenderInfo()},this.onmousemove=window.onmousemove,window.onmousemove=t=>{this.pointer.x=t.clientX,this.pointer.y=t.clientY,this.onmousemove&&this.onmousemove(t)},this.onmouseout=window.onmouseout,window.onmouseout=()=>{this.pointer.x=null,this.pointer.y=null,this.onmouseout&&this.onmouseout()}}initializeCanvas(){var t;this.canvas=document.createElement("canvas"),this.canvas.style.cssText=`position:fixed;top:0;left:0;z-index:${(t=CNCONFIG).zIndex};opacity:${t.opacity}`,this.updateCanvasSize(),document.body.appendChild(this.canvas)}optimizeChunkSize(){const t=Math.round(CNCONFIG.max_d*Math.max(CNCONFIG.chunk_size_optimize_constant,.25));console.log("[c-noice.js] Optimized chunk size:",t);const i=i=>{const e=e=>Math.abs(i/e-t);let n=i/t;return e(Math.floor(n))<e(Math.ceil(n))?Math.floor(n):Math.ceil(n)};CNCONFIG.X_CHUNK=i(this.canvas.width),CNCONFIG.Y_CHUNK=i(this.canvas.height),console.log(`[c-noice.js] Chunk Number: ${CNCONFIG.X_CHUNK}*${CNCONFIG.Y_CHUNK}`)}async pendingRender(){this.render_info.draw?(this.render_info.need_initialize&&(this.optimizeChunkSize(),this.grid=new s(this.canvas.width,this.canvas.height),this.fps_manager=new a(this.grid),await this.fps_manager.initialize(),this.simulator=new o(this.ctx,this.grid,this.pointer),this.render_info.need_initialize=!1,console.log("[c-noice.js] Canvas Initialized!"),console.log(`[c-noice.js] Canvas Size: ${this.canvas.width}*${this.canvas.height}`)),this.requestFrame()):Date.now()-this.render_info.last_changed_time>1e3?(this.render_info.draw=!0,this.pendingRender()):setTimeout((()=>{this.pendingRender()}),1e3*this.render_info.delay_after)}requestFrame(){this.simulator.draw(),this.tid=setTimeout((()=>{this.pendingRender()}),1e3/CNCONFIG.render_rate)}destroy(){window.onmousemove=this.onmousemove,window.onmouseout=this.onmouseout,i(this.tid),document.body.removeChild(this.canvas)}}}));
